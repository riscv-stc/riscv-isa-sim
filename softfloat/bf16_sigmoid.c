#include "platform.h"
#include "softfloat.h"
#include "internals.h"



bfloat16_t bf16_sigmoid( bfloat16_t a )
{
  
  union ui16_bf16 uA;
  uint_fast16_t uiA;
  bool signA;
  int_fast16_t expA;
  uint_fast16_t sigA;

  uint_fast16_t uiZ;
  union ui16_bf16 uZ;

  //get the signal\exp\fraction bits from input float number a
  uA.f = a;
  uiA = uA.ui;
  signA = signBF16UI( uiA );
  expA = expBF16UI( uiA );
  sigA = fracBF16UI( uiA );

  //if expA = 0xFF, handle the NaN and infinite number
  if( 0xFF == expA )
  {
    //if NaN input
    if( sigA )
    {
      uiZ = signA ? 0xffc0 : 0x7fc0;//-NaN or NaN
      uZ.ui = uiZ;
      return uZ.f;
    }
    //infinite number input
    uiZ = signA ? 0x0 : 0x3f80; // 0 or 1
    uZ.ui = uiZ;
    return uZ.f;
  }

  if( a.v > 0xc2b9 ) //a<-92.5
  {
    uZ.ui = 0;
    return uZ.f;
  }
  if( ( a.v > 0x40c7 ) && ( a.v < 0x8000 ) ) //a>6.21875
  {
    uZ.ui = 0x3f80;
    return uZ.f;
  }

  if( a.v >= 0xc2ae  && a.v <= 0xc2b9 )
  {
    uint8_t index = a.v - 0xc2ae;
    bfloat16_t makeup_table[] = { {0xb3}, {0x6d}, {0x42}, {0x28}, {0x18}, {0xf}, {0x9}, {0x5}, {0x3}, {0x2}, {0x1}, {0x1} };
    return makeup_table[ index ];
  }

  /** when x=nln2, the sigmoid(x) and all levels of deratives are easy to compute, 
   * so use the taylor series when x close to x0=nln2.
   */ 
  float32_t ln2_val_, ln2_recip_;
  ln2_val_.v = 0x3f317218; // ln2=0.6931471805599453
  ln2_recip_.v = 0x3fb8aa3b; // 1/ln2=1.4426950408889634


  float32_t n = f32_roundToInt( f32_mul( bf16_to_f32( a ), ln2_recip_ ), softfloat_round_near_maxMag, false ); // n = round(x/ln2) -14~14
  int32_t n_int = f32_to_i32( n, softfloat_round_near_maxMag, false );
  float32_t x0 = f32_mul( n, ln2_val_ ); // x0 = n * ln2
  bfloat16_t dx = f32_to_bf16( f32_sub( bf16_to_f32( a ), x0 ) );

  //taylor series
  bfloat16_t val_n_1[] = { 
  {0x0080}, {0x0100}, {0x0180}, {0x0200}, {0x0280}, {0x0300}, {0x0380}, {0x0400}, {0x0480}, {0x0500}, {0x0580}, {0x0600}, {0x0680}, {0x0700}, {0x0780}, {0x0800}, 
  {0x0880}, {0x0900}, {0x0980}, {0x0a00}, {0x0a80}, {0x0b00}, {0x0b80}, {0x0c00}, {0x0c80}, {0x0d00}, {0x0d80}, {0x0e00}, {0x0e80}, {0x0f00}, {0x0f80}, {0x1000}, 
  {0x1080}, {0x1100}, {0x1180}, {0x1200}, {0x1280}, {0x1300}, {0x1380}, {0x1400}, {0x1480}, {0x1500}, {0x1580}, {0x1600}, {0x1680}, {0x1700}, {0x1780}, {0x1800}, 
  {0x1880}, {0x1900}, {0x1980}, {0x1a00}, {0x1a80}, {0x1b00}, {0x1b80}, {0x1c00}, {0x1c80}, {0x1d00}, {0x1d80}, {0x1e00}, {0x1e80}, {0x1f00}, {0x1f80}, {0x2000}, 
  };
  bfloat16_t val_n_2[] = { 
  {0x2080}, {0x2100}, {0x2180}, {0x2200}, {0x2280}, {0x2300}, {0x2380}, {0x2400}, {0x2480}, {0x2500}, {0x2580}, {0x2600}, {0x2680}, {0x2700}, {0x2780}, {0x2800}, 
  {0x2880}, {0x2900}, {0x2980}, {0x2a00}, {0x2a80}, {0x2b00}, {0x2b80}, {0x2c00}, {0x2c80}, {0x2d00}, {0x2d80}, {0x2e00}, {0x2e80}, {0x2f00}, {0x2f80}, {0x3000}, 
  {0x3080}, {0x3100}, {0x3180}, {0x3200}, {0x3280}, {0x3300}, {0x3380}, {0x3400}, {0x3480}, {0x3500}, {0x3580}, {0x3600}, {0x3680}, {0x3700}, {0x3780}, {0x3800}, 
  {0x3880}, {0x3900}, {0x3980}, {0x3a00}, {0x3a80}, {0x3b00}, {0x3b7f}, {0x3bfe}, {0x3c7c}, {0x3cf8}, {0x3d71}, {0x3de4}, {0x3e4d}, {0x3eab}, {0x3f00}, {0x3f2b}, 
  };
  bfloat16_t val_n_3[] = { {0x3f4d}, {0x3f64}, {0x3f71}, {0x3f78}, {0x3f7c}, {0x3f7e}, {0x3f7f}, {0x3f80} };
  bfloat16_t der_1_1[] = { 
  {0x0080}, {0x0100}, {0x0180}, {0x0200}, {0x0280}, {0x0300}, {0x0380}, {0x0400}, {0x0480}, {0x0500}, {0x0580}, {0x0600}, {0x0680}, {0x0700}, {0x0780}, {0x0800}, 
  {0x0880}, {0x0900}, {0x0980}, {0x0a00}, {0x0a80}, {0x0b00}, {0x0b80}, {0x0c00}, {0x0c80}, {0x0d00}, {0x0d80}, {0x0e00}, {0x0e80}, {0x0f00}, {0x0f80}, {0x1000}, 
  {0x1080}, {0x1100}, {0x1180}, {0x1200}, {0x1280}, {0x1300}, {0x1380}, {0x1400}, {0x1480}, {0x1500}, {0x1580}, {0x1600}, {0x1680}, {0x1700}, {0x1780}, {0x1800}, 
  {0x1880}, {0x1900}, {0x1980}, {0x1a00}, {0x1a80}, {0x1b00}, {0x1b80}, {0x1c00}, {0x1c80}, {0x1d00}, {0x1d80}, {0x1e00}, {0x1e80}, {0x1f00}, {0x1f80}, {0x2000}, 
  };
  bfloat16_t der_1_2[] = {
  {0x2080}, {0x2100}, {0x2180}, {0x2200}, {0x2280}, {0x2300}, {0x2380}, {0x2400}, {0x2480}, {0x2500}, {0x2580}, {0x2600}, {0x2680}, {0x2700}, {0x2780}, {0x2800}, 
  {0x2880}, {0x2900}, {0x2980}, {0x2a00}, {0x2a80}, {0x2b00}, {0x2b80}, {0x2c00}, {0x2c80}, {0x2d00}, {0x2d80}, {0x2e00}, {0x2e80}, {0x2f00}, {0x2f80}, {0x3000}, 
  {0x3080}, {0x3100}, {0x3180}, {0x3200}, {0x3280}, {0x3300}, {0x3380}, {0x3400}, {0x3480}, {0x3500}, {0x3580}, {0x3600}, {0x3680}, {0x3700}, {0x3780}, {0x3800}, 
  {0x3880}, {0x3900}, {0x3980}, {0x3a00}, {0x3a80}, {0x3aff}, {0x3b7e}, {0x3bfc}, {0x3c78}, {0x3cf1}, {0x3d63}, {0x3dca}, {0x3e24}, {0x3e64}, {0x3e80}, {0x3e64}, 
  };
  bfloat16_t der_1_3[] = { {0x3e24}, {0x3dca}, {0x3d63}, {0x3cf1}, {0x3c78}, {0x3bfc}, {0x3b7e}, {0x3aff} };
  bfloat16_t der_2_1[] = { 
  {0x0000}, {0x0080}, {0x0100}, {0x0180}, {0x0200}, {0x0280}, {0x0300}, {0x0380}, {0x0400}, {0x0480}, {0x0500}, {0x0580}, {0x0600}, {0x0680}, {0x0700}, {0x0780}, 
  {0x0800}, {0x0880}, {0x0900}, {0x0980}, {0x0a00}, {0x0a80}, {0x0b00}, {0x0b80}, {0x0c00}, {0x0c80}, {0x0d00}, {0x0d80}, {0x0e00}, {0x0e80}, {0x0f00}, {0x0f80}, 
  {0x1000}, {0x1080}, {0x1100}, {0x1180}, {0x1200}, {0x1280}, {0x1300}, {0x1380}, {0x1400}, {0x1480}, {0x1500}, {0x1580}, {0x1600}, {0x1680}, {0x1700}, {0x1780}, 
  {0x1800}, {0x1880}, {0x1900}, {0x1980}, {0x1a00}, {0x1a80}, {0x1b00}, {0x1b80}, {0x1c00}, {0x1c80}, {0x1d00}, {0x1d80}, {0x1e00}, {0x1e80}, {0x1f00}, {0x1f80}, 
  };
  bfloat16_t der_2_2[] = {
  {0x2000}, {0x2080}, {0x2100}, {0x2180}, {0x2200}, {0x2280}, {0x2300}, {0x2380}, {0x2400}, {0x2480}, {0x2500}, {0x2580}, {0x2600}, {0x2680}, {0x2700}, {0x2780}, 
  {0x2800}, {0x2880}, {0x2900}, {0x2980}, {0x2a00}, {0x2a80}, {0x2b00}, {0x2b80}, {0x2c00}, {0x2c80}, {0x2d00}, {0x2d80}, {0x2e00}, {0x2e80}, {0x2f00}, {0x2f80}, 
  {0x3000}, {0x3080}, {0x3100}, {0x3180}, {0x3200}, {0x3280}, {0x3300}, {0x3380}, {0x3400}, {0x3480}, {0x3500}, {0x3580}, {0x3600}, {0x3680}, {0x3700}, {0x3780}, 
  {0x3800}, {0x3880}, {0x3900}, {0x3980}, {0x39ff}, {0x3a7e}, {0x3afc}, {0x3b78}, {0x3bf1}, {0x3c62}, {0x3cc8}, {0x3d1d}, {0x3d45}, {0x3d18}, {0x0000}, {0xbd18}, 
  };
  bfloat16_t der_2_3[] = { {0xbd45}, {0xbd1d}, {0xbcc8}, {0xbc62}, {0xbbf1}, {0xbb78}, {0xbafc}, {0xba7e} };
  bfloat16_t der_3_1[] = { 
  {0x0000}, {0x0000}, {0x0000}, {0x00ab}, {0x012b}, {0x01ab}, {0x022b}, {0x02ab}, {0x032b}, {0x03ab}, {0x042b}, {0x04ab}, {0x052b}, {0x05ab}, {0x062b}, {0x06ab}, 
  {0x072b}, {0x07ab}, {0x082b}, {0x08ab}, {0x092b}, {0x09ab}, {0x0a2b}, {0x0aab}, {0x0b2b}, {0x0bab}, {0x0c2b}, {0x0cab}, {0x0d2b}, {0x0dab}, {0x0e2b}, {0x0eab}, 
  {0x0f2b}, {0x0fab}, {0x102b}, {0x10ab}, {0x112b}, {0x11ab}, {0x122b}, {0x12ab}, {0x132b}, {0x13ab}, {0x142b}, {0x14ab}, {0x152b}, {0x15ab}, {0x162b}, {0x16ab}, 
  {0x172b}, {0x17ab}, {0x182b}, {0x18ab}, {0x192b}, {0x19ab}, {0x1a2b}, {0x1aab}, {0x1b2b}, {0x1bab}, {0x1c2b}, {0x1cab}, {0x1d2b}, {0x1dab}, {0x1e2b}, {0x1eab}, 
  };
  bfloat16_t der_3_2[] = {
  {0x1f2b}, {0x1fab}, {0x202b}, {0x20ab}, {0x212b}, {0x21ab}, {0x222b}, {0x22ab}, {0x232b}, {0x23ab}, {0x242b}, {0x24ab}, {0x252b}, {0x25ab}, {0x262b}, {0x26ab}, 
  {0x272b}, {0x27ab}, {0x282b}, {0x28ab}, {0x292b}, {0x29ab}, {0x2a2b}, {0x2aab}, {0x2b2b}, {0x2bab}, {0x2c2b}, {0x2cab}, {0x2d2b}, {0x2dab}, {0x2e2b}, {0x2eab}, 
  {0x2f2b}, {0x2fab}, {0x302b}, {0x30ab}, {0x312b}, {0x31ab}, {0x322b}, {0x32ab}, {0x332b}, {0x33ab}, {0x342b}, {0x34ab}, {0x352b}, {0x35ab}, {0x362b}, {0x36ab}, 
  {0x372b}, {0x37ab}, {0x382a}, {0x38aa}, {0x3929}, {0x39a8}, {0x3a25}, {0x3aa0}, {0x3b16}, {0x3b84}, {0x3bca}, {0x3bdc}, {0x3a8c}, {0xbc4a}, {0xbcab}, {0xbc4a}, 
  };
  bfloat16_t der_3_3[] = { {0x3a8c}, {0x3bdc}, {0x3bca}, {0x3b84}, {0x3b16}, {0x3aa0}, {0x3a25}, {0x39a8} };

  bfloat16_t val_n, der_1, der_2, der_3;
  if( n_int >= -126 && n_int <= -63 )
  {
    val_n = val_n_1[ n_int + 126];
    der_1 = der_1_1[ n_int + 126 ];
    der_2 = der_2_1[ n_int + 126 ];
    der_3 = der_3_1[ n_int + 126 ];
  }
  else if( n_int < 2 )
  {
    val_n = val_n_2[ n_int + 62 ];
    der_1 = der_1_2[ n_int + 62 ];
    der_2 = der_2_2[ n_int + 62 ];
    der_3 = der_3_2[ n_int + 62 ];
  }
  else
  {
    val_n = val_n_3[ n_int - 2 ];
    der_1 = der_1_3[ n_int - 2 ];
    der_2 = der_2_3[ n_int - 2 ];
    der_3 = der_3_3[ n_int - 2 ];
  }
  

  uZ.f = bf16_add( val_n, bf16_mul( dx,
        bf16_add( der_1, bf16_mul( dx,
        bf16_add( der_2, bf16_mul( dx, 
        der_3 ) ) ) ) ) );

  return uZ.f;

}